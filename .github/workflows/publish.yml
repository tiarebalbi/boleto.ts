# This workflow automatically publishes the package to GitHub Packages when a release is created.
# The release tag should be the version number (e.g., v1.0.0 or 1.0.0).
# The workflow will:
# 1. Extract the version from the release tag
# 2. Run tests to ensure quality
# 3. Build the package
# 4. Publish to GitHub Packages
name: Publish Package

on:
  release:
    types: [created]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@tiarebalbi'

      - name: Set package version from release tag
        run: |
          TAG_VERSION="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present (e.g., v1.0.0 -> 1.0.0)
          VERSION="${TAG_VERSION#v}"
          # Validate that the version follows semver pattern
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$ ]]; then
            echo "Error: Invalid version format '$VERSION'. Expected semver (e.g., 1.0.0, 1.0.0-beta.1)"
            exit 1
          fi
          echo "Setting package version to: $VERSION"
          npm version "$VERSION" --no-git-tag-version --allow-same-version

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build
        run: npm run build

      - name: Publish to GitHub Packages
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
